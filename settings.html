<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Xplorare - Settings</title>
  <style id="theme-style">
    body {
      background-color: #FFE4E4;
      color: #333;
    }
  </style>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
    
      min-height: 100vh;
      padding: 20px;
    }

    .profile-container {
      background-color: white;
      border-radius: 24px;
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      min-height: 600px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 40px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #FF4B6E;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 1px solid #eee;
    }

    .profile-picture {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background-color: #FFE4E4;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: #FF4B6E;
    }

    .profile-info h1 {
      font-size: 32px;
      margin-bottom: 10px;
      color: #333;
    }

    .profile-info p {
      color: #666;
      margin-bottom: 15px;
    }

    .edit-profile-btn {
      padding: 8px 20px;
      background-color: #FF4B6E;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .edit-profile-btn:hover {
      background-color: #ff3459;
    }

    .profile-sections {
      display: grid;
      grid-template-rows: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
    }

    .section {
      background-color: #fff;
      border-radius: 16px;
      padding: 25px;
      border: 1px solid #eee;
    }

    .section h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #333;
    }

    .info-item {
      margin-bottom: 15px;
    }

    .info-item label {
      display: block;
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .info-item p {
      color: #333;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
      }

      .profile-sections {
        grid-template-columns: 1fr;
      }
    }
    .credentials-flex {
  display: flex;
  flex-wrap: wrap;
  gap: 30px;
}

.credentials-left,
.credentials-right {
  flex: 1;
  min-width: 280px;
}

.credentials-right input,
.credentials-right select {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
}

  </style>
</head>
<body>
  <div class="profile-container">
    <div class="header">
      <div class="logo">Xplorare.</div>
      <button id="back" class="edit-profile-btn">Back</button>
    </div>

    <div class="profile-header">
        <div class="profile-picture" id="profile-picture-container">
            <img id="profile-img" src="" alt="Profile Picture" style="display: none; width: 100%; height: 100%; border-radius: 50%;" />
            <span id="profile-initials">?</span>
          </div>          
      <div class="profile-info">
        <h1>Settings</h1>
      </div>
    </div>

    <div class="profile-sections" >
        <div class="section">
        <div class="section">
            <h2>Edit Credentials</h2>
          
            <div class="credentials-flex">
              <!-- LEFT SIDE -->
              <div class="credentials-left">
                <div class="info-item">
                  <label for="edit-name">Full Name</label>
                  <input type="text" id="edit-name" placeholder="Enter your name" />
                </div>
                
                <div class="info-item">
                  <label for="edit-password">New Password</label>
                  <input type="password" id="edit-password1" placeholder="Enter new password" />
                </div>
                <div class="info-item">
                  <label for="edit-password">Confirm Password</label>
                  <input type="password" id="edit-password2" placeholder="Confirm password" />
                </div>
              </div>
          
              <!-- RIGHT SIDE -->
              <div class="credentials-right">
                <div class="info-item">
                  <label for="profile-pic-upload">Update or Upload Profile Picture</label>
                  <input type="file" id="profile-pic-upload" accept="image/*" />
                  <p style="font-size: 12px; color: #999;">Max size: 2MB</p>
                </div>
                <div class="info-item">
                  <label for="userphone">Your Phone Number</label>
                  <input type="text" id="userphone" placeholder="Enter 10-digit phone number" />
                </div>
                
               
              </div>
            </div>
          </div>
          
            <div class="section">
                <h2>Emergency Contacts</h2>
                <div id="alert-box" class="alert"></div>
                <form id="emergencyContactForm">
                    <div style="display: flex;flex-direction:row;justify-content: space-between;">
                    <div>
                    <label>
                      Name:
                      <br>
                      <input type="text" id="contactName" required />
                    </label>
                    <br />
                    <br>
                    
                    <label>
                      Phone Number:
                      <br>
                      <select id="countryCode" required>
                        <option value="+91">🇮🇳 India (+91)</option>
                        <option value="+1">🇺🇸 USA (+1)</option>
                        <option value="+44">🇬🇧 UK (+44)</option>
                        <option value="+971">🇦🇪 UAE (+971)</option>
                        <option value="+61">🇦🇺 Australia (+61)</option>
                        <!-- Add more countries if needed -->
                      </select>
                      <input type="text" id="phoneNumber" required />
                    </label>
                    <br />
                    </div>
                    <div>
                    
                    <label>
                      Relationship:
                      <br>
                      <select id="relationship">
                        <option value="">Select</option>
                        <option value="Parent">Parent</option>
                        <option value="Sibling">Sibling</option>
                        <option value="Friend">Friend</option>
                        <option value="Partner">Partner</option>
                        <option value="Other">Other</option>
                      </select>
                    </label>
                    <br />
                    <br>
                    <button type="submit" class="edit-profile-btn">Add Emergency Contact</button>
                    
                </div>
            </div>
            <br>
            <br>
            </form>
            <div class="section">
            <ul id="emergency-contacts" style="margin-left: 20px;">
                <li>Loading contacts...</li>
            </ul>
            </div>
                
        </div>
        <button class="edit-profile-btn" onclick="saveCredentials()" style="max-width: fit-content;">Save Changes</button>
        </div>
          </div>
      

          <div class="section">
              <h2>Theme Settings</h2>
              <div class="info-item">
                <label><input type="radio" name="theme" value="light" checked> Light Mode</label><br />
                <label><input type="radio" name="theme" value="dark"> Dark Mode</label>
              </div>
              <button class="edit-profile-btn" onclick="applyTheme()">Apply Theme</button>
            </div>
      <div class="section">
        <h2>Account Settings</h2>
        <div style="display: flex;justify-content: space-between;">
        <div class="info-item">
            <button class="edit-profile-btn" onclick="confirmDeleteAccount()">Delete Account</button>
        </div>
        <div class="info-item">
            <button class="edit-profile-btn" id="logout-button" >Logout</button>
        </div>
        </div>
        </div>
        </div>
          
          
      </div>
    </div>

    
  </div>
  <script src="theme.js"></script>
  <script>
    function showAlert(message, type = "error") {
  const alertBox = document.getElementById("alert-box");
  alertBox.textContent = message;
  alertBox.className = "alert " + (type === "success" ? "alert-success" : "alert-error");
  alertBox.style.display = "block";
  
}
    document.getElementById('back').addEventListener('click', function () {
      window.location.href = 'home2.html';
    });

    document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");

  if (!token) {
    alert("You must log in first!");
    window.location.href = "login2.html";
    return;
  }

  try {
    const response = await fetch("http://localhost:5000/profile", {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    });

    const data = await response.json();

    if (response.ok) {
      document.getElementById("edit-name").value = `${data.first_name} ${data.last_name}`;
      document.getElementById("userphone").value = data.userphone || "";// ✅ set phone number

      const initials = `${data.first_name?.charAt(0) || ''}${data.last_name?.charAt(0) || ''}`.toUpperCase();
      const profileImg = document.getElementById("profile-img");
      const initialsDiv = document.getElementById("profile-initials");

      if (data.profile_pic) {
        profileImg.src = `http://localhost:5000/uploads/${data.profile_pic}`;
        profileImg.style.display = "block";
        initialsDiv.style.display = "none";
      } else {
        initialsDiv.innerText = initials || "?";
        initialsDiv.style.display = "flex";
        profileImg.style.display = "none";
      }
      const phoneInput = document.getElementById("userphone");
      if (data.userphone) {
        phoneInput.value = data.userphone;
        phoneInput.setAttribute("data-saved", data.userphone); // for reuse in loadContacts
        loadContacts();
      } else {
        phoneInput.value = "";
        showAlert("Add your contact info first!");
        document.getElementById("emergencyContactForm").style.display="none";
      }// ✅ load emergency contacts
    } else {
      alert(data.error || "Failed to load profile.");
      window.location.href = "login2.html";
    }
  } catch (error) {
    console.error("Error fetching profile:", error);
    alert("Something went wrong!");
  }
});


    document.getElementById("logout-button").addEventListener("click", function () {
      localStorage.removeItem("token");
      alert("Logged out successfully!");
      window.location.href = "login2.html";
    });
    //saving updated 
    async function saveCredentials() {
  const token = localStorage.getItem("token");
  const userphone = document.getElementById("userphone").value.trim();
const phoneRegex = /^\d{10}$/;

if (userphone && !phoneRegex.test(userphone)) {
  return alert("Phone number must be exactly 10 digits.");
}

  const fullName = document.getElementById("edit-name").value.trim().split(" ");
  const first_name = fullName[0] || "";
  const last_name = fullName[1] || "";

  const password1 = document.getElementById("edit-password1").value;
  const password2 = document.getElementById("edit-password2").value;
  
  const profilePicFile = document.getElementById("profile-pic-upload").files[0];

  if (password1 && password1 !== password2) {
    alert("Passwords do not match.");
    return;
  }

  const formData = new FormData();
  formData.append("first_name", first_name);
  formData.append("last_name", last_name);
  
  if (password1) formData.append("password", password1);
  if (profilePicFile) formData.append("profile_pic", profilePicFile);
if (userphone) formData.append("userphone", userphone);

  try {
    const response = await fetch("http://localhost:5000/update-profile", {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${token}`
      },
      body: formData,
    });

    const data = await response.json();

    if (response.ok) {
      alert("Profile updated successfully!");
      window.location.reload();
    } else {
      alert(data.error || "Failed to update profile.");
    }
  } catch (err) {
    console.error("Update error:", err);
    alert("Something went wrong.");
  }
}

    async function confirmDeleteAccount() {
  const confirmDelete = confirm("Are you sure you want to delete your account? This action cannot be undone.");
  if (!confirmDelete) return;

  const password = prompt("Please enter your password to confirm:");

  if (!password) {
    alert("Deletion cancelled. Password was not provided.");
    return;
  }

  try {
    const token = localStorage.getItem("token");

    const response = await fetch("http://localhost:5000/delete-account", {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ password })
    });

    const data = await response.json();

    if (response.ok) {
      alert("Account deleted successfully.");
      localStorage.removeItem("token");
      window.location.href = "login2.html"; // or your landing page
    } else {
      alert(data.error || "Failed to delete account. Please try again.");
    }
  } catch (error) {
    console.error("Error deleting account:", error);
    alert("An error occurred. Please try again later.");
  }
}

document.getElementById("emergencyContactForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const name = document.getElementById("contactName").value.trim();
    const countryCode = document.getElementById("countryCode").value.trim();
    const phone = document.getElementById("phoneNumber").value.trim();
    const relationship = document.getElementById("relationship").value;

    const nameRegex = /^[A-Za-z ]+$/;
    const phoneRegex = /^\d{10}$/;

    if (!nameRegex.test(name)) {
      return alert("Name must only contain letters and spaces.");
    }
    if (!phoneRegex.test(phone)) {
      return alert("Phone number must be exactly 10 digits.");
    }
    if (!relationship) {
      return alert("Please select a relationship.");
    }

    const fullPhone = `${countryCode}${phone}`;
    const token = localStorage.getItem("token");

    fetch("http://localhost:5000/emergency", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({
        name,
        phone: fullPhone,
        country: countryCode, // optional: separate if needed
        relationship,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        alert(data.message || "Contact saved!");
        document.getElementById("emergencyContactForm").reset();
        loadContacts(); 
      })
      .catch((err) => {
        console.error(err);
        alert("Failed to save contact.");
      });
  });
  async function deleteContact(contactId) {
  const token = localStorage.getItem("token");
  const confirmDel = confirm("Are you sure you want to delete this contact?");
  if (!confirmDel) return;

  try {
    const res = await fetch(`http://localhost:5000/emergency/${contactId}`, {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    const data = await res.json();

    if (res.ok) {
      alert(data.message || "Contact deleted.");
      document.getElementById("emergencyContactForm").reset();
      loadContacts(); // refresh the list
      document.getElementById("emergencyContactForm").style.display = "block"; // show form back
    } else {
      alert(data.error || "Failed to delete.");
    }
  } catch (err) {
    console.error("Error deleting contact", err);
    alert("Something went wrong while deleting.");
  }
}
async function loadContacts() {
  const token = localStorage.getItem("token");

  try {
    const res = await fetch("http://localhost:5000/emergency", {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    const data = await res.json();

    const contactList = document.getElementById("emergency-contacts");
    contactList.innerHTML = ""; // clear previous entries

    // Remove old limit message if any
    const existingMsg = document.getElementById("limit-msg");
    if (existingMsg) existingMsg.remove();

    if (data.length === 0) {
      contactList.innerHTML = "<li>No contacts added yet.</li>";
    } else {
      data.forEach((contact) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <b>${contact.name}</b> (${contact.relationship}) - ${contact.phone}
          <button style="margin-left: 10px;" onclick="deleteContact(${contact.id})">❌</button>
        `;
        contactList.appendChild(li);
      });
    }

    // If 3 contacts, hide form and show message
    if (data.length >= 3) {
      document.getElementById("emergencyContactForm").style.display = "none";
      const msg = document.createElement("p");
      msg.id = "limit-msg";
      msg.style.color = "red";
      msg.innerText = "Maximum of 3 emergency contacts reached.";
      console.log(msg.innerText)
      contactList.parentElement.appendChild(msg);
    } else {
      document.getElementById("emergencyContactForm").style.display = "block";
    }

  } catch (err) {
    console.error("Error loading contacts", err);
  }
}

window.loadContacts = loadContacts;
loadContacts(); 

  </script>
</body>
</html>
